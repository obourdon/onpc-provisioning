---
- hosts: infra-master
  become: no

  vars_files:
    - ../vars/infra-master-configure-system_vars.yml
    - ../vars/infra-master-deploy-bifrost_vars.yml

  tasks:

    - import_tasks: ../tasks/operational_informations.yml

- hosts: kvm-master
  become: no

  tasks:

    - include_tasks: ../tasks/kvm_vm_create.yml
      vars:
        vmname: "{{ vm_item.name }}"
        vmcpus: "{{ vm_item.cpus }}"
        vmmemorysizegb: "{{ vm_item.mem }}"
        vmdisksnb: "{{ vm_item.disks | default(1) }}"
        vmdisksizegb: "{{ vm_item.hdd }}"
        vncport: "{{ vm_item.vnc }}"
        vbmc_port: "{{ vm_item.bmc }}"
        vmmacprefix: "52:54:01"
      with_items:
        - { name: "master", cpus: 2, mem: 4, hdd: 60, vnc: 5901, bmc: 6001 }
        - { name: "slave-1", cpus: 8, mem: 12, disks: 3, hdd: 100, vnc: 5902, bmc: 6002 }
        - { name: "slave-2", cpus: 8, mem: 12, disks: 3, hdd: 100, vnc: 5903, bmc: 6003 }
        - { name: "slave-3", cpus: 8, mem: 12, disks: 3, hdd: 100, vnc: 5904, bmc: 6004 }
      loop_control:
        loop_var: vm_item

- hosts: infra-master
  become: no

  vars_files:
    - ../vars/infra-master-configure-system_vars.yml
    - ../vars/infra-master-deploy-bifrost_vars.yml

  tasks:

    - import_tasks: ../tasks/nodes_get_status.yml
      vars:
        node_status_delay: 30
        node_status_retries: 20
        nodes_nb: 4

    - name: Extracting VMs names from facts
      set_fact:
        node_infos: "{{ hostvars[inventory_hostname].registered_status.json }}"
        node_names: "{{ hostvars[inventory_hostname].registered_status.json | json_query('keys(@)') }}"
        node_ips: "{{ hostvars[inventory_hostname].registered_status.json | json_query('values(@)') | map(attribute='extra/all/interfaces/eth0/ip') | list }}"

    - name: Waiting for VMs to be reachable by SSH
      wait_for:
        sleep: 60
        # Need to increase timeout to 2h because on KVM/libvirt, Ironic provisioning
        # takes longer when several VMs are bootstrapped in //
        timeout: 7200
        port: 22
        host: '{{ item }}'
        search_regex: OpenSSH
      with_items: "{{ node_ips }}"

    - name: Creating OSA inventory file
      template:
        src: ../templates/inventory.cfg.j2
        dest: "{{ systemuserhome }}/osa-inventory"
      vars:
        # TODO next variables to be retrieved from facts
        infra_master_ip: "{{ hostvars[inventory_hostname].ansible_br_host.ipv4.address }}"
        osa_master_ip: "{{ hostvars[inventory_hostname].registered_status.json.get(node_names[0]).get('extra/all/interfaces/eth0/ip') }}"
        osa_nodes: "{{ node_names }}"
        bridge_itf: "{{ kvm_bridge_itf }}"

    - include_tasks: ../tasks/store_facts.yml facts_file="opennext_infra_master_create_osa_nodes"
      vars:
        keys_to_store:
          - "^node_infos$"
          - "^node_ips$"
          - "^node_names$"
          - "^registered_machines$"
          - "^registered_status$"
